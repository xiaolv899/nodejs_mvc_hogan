/**
 * Created by Administrator on 2015/6/9.
 */
var path = require('path');
var option = {set :0};

exports = module.exports = function webAuth(options){
    var chkurl = function($path, $curl){
        return ($path.toLowerCase()==$curl.toLowerCase())
            || path.join($curl.toLowerCase(),'').indexOf(path.join($path.toLowerCase(),'/'))==0;
    };
    this.opt = options || {};
    this.opt.set = option.set;
    option = this.opt;
    return function webAuth(req, res, next){
        /*if(!req.session)session.startSession(req, res, function(){

        });*/
        var $ispath = false;
        if(options.path){
            if(typeof options.path === 'string'){
                $ispath = chkurl(options.path, req.url);
            }else{
                for(var x in options.path){
                    $ispath = chkurl(options.path[x], req.url);
                    if($ispath)break;
                    //console.log(this.opt.path[x]);
                }
            }
            //console.log($ispath);
        }
        //console.log(req.url);
        /*console.log(req.session.getToken());
        if(req.session.has(this.opt.key)){
            console.log("Login");
        }else {
            var t1 = req.session.all();
            console.log(t1);
            req.session.push("username", "12345");
            console.log(t1);
        }
        console.log(req.session.has(this.opt.key));*/
        //console.log(req.session.all());
        //console.log(options);
        var $isnext = true;
        if($ispath){
            //判断是否登陆
            if(!req.session.has(options.key)){
                res.redirect(options.login);
                $isnext = false;
            }
        }
        if($isnext)next();
    };
    //console.log(arguments.length);
    //arguments[2]();
};